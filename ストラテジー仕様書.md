# 株式市場における多層モデルのLong-Short戦略仕様書

## 1. プロジェクト概要

### 目的
このストラテジーの主な目的は、**リスクを抑えながら大きなリターンを得る**こと。特にドローダウン（資産の大幅な減少）を最小限に抑えることで、安定したメンタルを維持しながら運用を続けることを重視しています。

### 対象銘柄
ユニバースとして、**日本株の中でも大型の銘柄群であるTOPIX500採用銘柄**を選定しています。

### 日本株を取引対象に選んだ理由
1. **データ取得の容易性**  
   - 個別銘柄の値動きや財務情報に至るまで、データを取得しやすい。
2. **特徴量設計のしやすさ**  
   - 日本市場が米国市場のクローズ後に開場するため、**米株・為替・債券・商品**などの情報を特徴量として活用しやすい。

### 大型株（TOPIX500）を取引対象に選んだ理由
1. **信用売りが可能**  
   - TOPIX500採用銘柄の多くが信用取引に対応しており、柔軟な売買戦略を組むことができる。
2. **流動性が高い**  
   - 出来高が多く、注文がスムーズに成立しやすいため、運用効率が高い。
3. **値動きが予測しやすい**  
   - 投機的な動きが少なく、比較的予測可能な値動きが期待できる。
4. **マーケットインパクトを抑えやすい**  
   - 運用資金が増えた場合でも、市場に与える影響を最小限に抑えた取引が可能。

### 業種分類
ユニバースであるTOPIX500採用銘柄を、独自に定義した**48業種**に分類し、業種単位で売買を行います。

#### 業種分類の利点
1. **分散効果**  
   - 業種ごとの取引でリスクを分散。
2. **柔軟性**  
   - 業種ごとの市場状況や特徴に応じたトレード戦略を適用可能。
3. **データ分析の効率化**  
   - 業種単位でのデータ集計と特徴量作成が可能。
4. **リターン予測のしやすさ**  
   - 業種ごとに特異なリターンを示すことが知られており、**業種間で予測結果の差異を出しやすい**。
   - **商社セクターと原油価格**のように、特定のセクターと指標のリターンとの相関が強い場合があり、予測精度を向上させやすい。
   - また、モデルの解釈性を担保しやすい。

#### 独自の業種再定義を行う理由
- **似通ったファクターの影響を受ける銘柄同士をグループ化**することで、予測精度を向上させるため。
  - 既存の**17業種**や**33業種**では、業種内の銘柄が必ずしも似通った値動きをしているわけではありません。
  - そのため、**似通った値動きをする銘柄をグループ化**し、それを基にインデックスを作成。

## 2. 基本アーキテクチャ

この戦略は以下の主要なコンポーネントから構成されています：

1. **データ取得・処理**
   - J-Quants APIを用いた株価情報・財務情報の取得
   - スクレイピングによる各種金融指標の取得
   - セクターインデックスの計算

2. **予測モデル**
   - 1層目: LASSO回帰モデル
   - 2層目: LightGBMモデル（1層目の予測を特徴として使用）
   - アンサンブル: 両モデルの重み付け集約

3. **ポートフォリオ構築**
   - 上位・下位セクターの選択
   - 銘柄選択とウェイト付け
   - 発注処理

4. **実行モジュール**
   - SBI証券APIとの連携
   - 取引履歴の管理

## 3. 売買条件

### 1. 売買トリガー
- 業種ごとの**当日日中リターン**（前処理済みデータ）を、機械学習で予測。
  - **上位3業種**を信用買い。
  - **下位3業種**を信用売り。
- **注文タイミング**: 寄付（寄成注文）。
- **決済方法**: 当日の引成で全て決済。
- **業種数の選定理由**:  
  - 上下1業種だとリターンは大きいが、リスク分散のために3業種とする。

### 2. リスク管理
- **利確・損切り条件**: なし（当日引けで必ず決済するため）。
- **最大ポジションサイズ**: 証券会社の定める上限単位数および空売り規制ルールに従う。
  - 独自の基準は特に設けていない。
- **マーケットトレンドのリスク回避**:  
  - 買いポジションと売りポジションの発注金額をほぼ同額に調整。これにより、マーケット全体のトレンド（上昇/下落）の影響を受けにくくし、リスクを低減している。
- **具体的なリスク管理の対応**:  
  - **最大保有単元数の管理**:  
    - 証券会社が規定する最大保有単元数を超えないように発注することで、リスクを管理。
  - **空売り規制への対応**:  
    - **すべての信用新規売り**は、**前日終値の90.5%程度の低い値段での指値注文**として発注することで、空売り規制を回避。

### 3. トレード頻度・期間
- **頻度**: 年間約250回のトレード（毎営業日）。
  - トレード回数が多いため、**期待値に近い結果を得やすい**設計。
- **保持期間**: 当日中（寄り付きでポジションを取り、引けで決済）。
  - 短期スパンの方が情報の劣化を防ぎ、機械学習による予測精度を保ちやすい。
  - **取引コストの優位性**:  
    - 寄引戦略では**手数料・信用料がゼロ**となるため、コスト面で有利。

## 4. データ取得と前処理

### 4.1 取得するデータ

- **株価データ**: J-Quants APIから取得（`StockAcquisitionFacade` クラス）
  - OHLCV（始値、高値、安値、終値、出来高）
  - 調整係数

- **財務データ**: J-Quants APIから取得
  - 発行済株式数
  - 予想EPS

- **市場指標データ**: スクレイピングで取得（`FeaturesUpdater` クラス）
  - 通貨ペア（USD/JPY、EUR/JPY など）
  - 債券（国債）
  - コモディティ
  - TOPIXなどの指数

### 4.2 セクター定義

- カスタム定義の48セクター分類を使用
- `SECTOR_REDEFINITIONS_CSV` パスで指定されたCSVファイルにセクター定義が記載

### 4.3 データ前処理

- **セクターインデックスの計算** (`SectorIndexCalculator` クラス)
  - 各銘柄の時価総額加重平均によりセクターインデックスを算出
  - 株式分割・併合を考慮した調整

- **目的変数の計算** (`TargetCalculator` クラス)
  - **定義**: 業種別インデックスの日中リターン（PCAでマーケットファクターを除去）
  - **計算方法**: 当日終値 / 当日始値 - 1
  - **PCAによるマーケットファクター除去の理由**:  
    - 主成分分析では、分散が最も大きい軸を第一主成分とする
    - 株式市場では、最も大きなファクターがマーケットリターンであるため、第一主成分を除去することで業種固有の値動きを抽出

- **特徴量の計算** (`FeaturesCalculator` クラス)
  - **外部データ**: 各種データの1日リターン
  - **業種別インデックス**: モメンタム（移動平均）とボラティリティ（標準偏差）を5日・21日スパンで算出
  - **業種情報**: カテゴリ変数として利用
  - **前段モデルの予測結果**: LASSOの生の予測値をLightGBMで使用
  - 通貨相対強度
  - 債券イールドとイールドカーブ
  - セクターの時価総額と予想EPS
  - 各指標のセクター内ランキング

## 5. 予測モデル

### 5.1 LASSO回帰モデル

1. **モデル概要**  
   - **特徴量を削減**しオーバーフィッティングを防止
   - **重要な特徴量に絞り込み解釈性を向上**
   - **業種ごとのモデリング理由**:  
     - 業種ごとに異なるファクターの影響を受けるため、それぞれに適した特徴量を採用
   - 使用ライブラリ: **scikit-learn**
   - **業種別に独立した48モデル**を構築

2. **入力データ**  
   - 主に経済指標データ（通貨、債券、コモディティ等）
   - 外部データの1日リターンのみを採用

3. **出力データ**  
   - 各業種の日中リターンを予測
   - **順位をLightGBMアンサンブルに使用**

4. **特徴量選択**
   - 最大5、最小3の特徴量を自動選択

5. **学習パラメータ**
   - RandomizedSearchCVによるalpha最適化

### 5.2 LightGBMモデル

1. **モデル概要**  
   - LASSOで捉えきれない非線形な関係を補完
   - 使用ライブラリ: **lightgbm**

2. **入力データ**  
   - 経済指標、価格データ
   - 全特徴量に加え、**LASSOの予測値（生値）**を特徴量として使用
   - 1日リターン、5/21日モメンタム、5/21日ボラティリティ等
   - カテゴリカル変数としてセクター情報

3. **出力データ**  
   - 全業種の日中リターン予測
   - **順位を最終予測に反映**

4. **学習パラメータ**:
   - `objective`: 'regression'
   - `metric`: 'rmse'
   - `boosting_type`: 'gbdt'
   - `learning_rate`: 0.001
   - `num_leaves`: 7
   - カスタムメトリック: numerai_corr（順位相関の特殊な変形）
   - ツリー深さを浅く設定しツリー数を増やす

### 5.3 アンサンブル方式

1. **方法**  
   - LASSOとLightGBMの出力順位を重み付け
   - **LASSO : LightGBM = 67 : 13**の比率で加重平均
   - 2つのモデルの予測結果を重み付けして合成

2. **意図**  
   - 非線形成分を反映し精度を向上

3. **出力**  
   - **昇順に順位化**し最終予測結果を得る
   - 各セクターの順位に基づく加重平均

## 6. ポートフォリオ構築

### 6.1 セクター選択

- 予測結果上位と下位からそれぞれ3個のセクターを選択
- 取引可能性を考慮（銘柄の半分以上が取引可能なセクターのみ選択）
- 必要に応じて、候補セクター数を拡大（デフォルト候補数=5）

### 6.2 銘柄選択ロジック

- 各セクター内で時価総額ウェイトに基づいて銘柄を選択
- 実際の購入単位数（100株単位）と理想的なウェイトとの調整
- 取引制限（信用建余力、空売り制限）の考慮

### 6.3 ポジションサイジング

- セクターごとの配分：均等配分がデフォルト
- セクター間での傾斜配分も可能（パラメータ `top_slope` で調整）
- 信用建余力に基づく総投資額の調整

## 7. 執行ロジック

### 7.1 取引タイミング

フラグ管理システム（`FlagManager` クラス）によって以下の実行タイミングを制御:

- **FETCH_DATA**: 7:00〜8:59（市場開場日のみ）
- **PREDICT**: 7:00〜8:59（市場開場日のみ）
- **TAKE_NEW_POSITIONS**: 7:00〜8:59（市場開場日のみ）
- **TAKE_ADDITIONAL_POSITIONS**: 9:00〜9:29（市場開場日のみ）
- **SETTLE_POSITIONS**: 11:30〜15:19（市場開場日のみ）
- **FETCH_RESULT**: 15:30〜23:59（市場開場日のみ）

### 7.2 注文種別

- 買いポジションの場合は寄付き成行注文
- 信用新規売りは前日終値の90.5%での指値注文（空売り規制回避のため）

### 7.3 決済ロジック

- 原則として当日の引け前に反対売買で決済
- 全ポジションの一括決済機能あり

### 7.4 エラー処理

- 発注失敗時の再試行機能
- エラーログの出力と通知

## 8. システム構成

### 8.1 主要クラス構成

- **SBIとの連携**
  - `SBIBrowserManager`: SBI証券ページへのアクセス管理
  - `MarginManager`: 信用建余力・買付余力の取得
  - `TradePossibilityManager`: 取引可能性情報の管理
  - `HistoryManager`: 取引履歴の管理

- **トレード管理**
  - `StockSelector`: 銘柄選択ロジック
  - `NewOrderMaker`: 新規注文発注
  - `PositionSettler`: ポジション決済
  - `TradeParameters`: 注文パラメータ管理

- **モデル管理**
  - `MLDataset`: 機械学習データセット管理
  - `LassoModel`: LASSO回帰モデル
  - `LgbmModel`: LightGBMモデル

### 8.2 データ永続化

- 学習済みモデルの保存
- 予測結果の保存
- 取引履歴の保存
- エラーログの保存

### 8.3 通知システム

- `SlackNotifier`: Slack連携による通知機能
  - プログラム開始・終了通知
  - エラー通知
  - 取引結果通知

## 9. バックテスト結果とパフォーマンス評価

### 9.1 テスト期間
- **学習期間**: 2014年1月1日 ～ 2021年12月31日  
- **テスト期間**: 2022年1月1日 ～ 2024年11月30日
- 1年毎に再学習を実施(例：2024年分のデータの予測には、2023年までのデータを使用) 

### 9.2 評価指標

`MetricsCalculator` クラスによる詳細なパフォーマンス指標計算:
- **Spearman順位相関係数**  
- **Numerai相関係数**  
- **リターン・リスク指標**  
  - **最大ドローダウン**: 資産のピークから谷への最大減少率。
- 日次リターン（税引前/税引後）
- 月次リターン
- シャープレシオ
- 累積リターン
- セクター別成績
- Long/Short別成績

### 9.3 主要な結果（テスト期間中の評価指標）

#### 日次ベース
- **日平均モデルリターン**: 0.1315%  
- **日平均実運用リターン**: 0.4077%  
- **日平均リターンの標準偏差**: 0.5353%  
- **日平均実運用リターンの標準偏差**: 1.6594%  
- **日次シャープレシオ**: 0.24567

#### 年間換算
- **年間モデルリターン**: 約32.9%（0.1315% × 250日）  
- **年間実運用リターン（税引前）**: 約101.9%（0.4077% × 250日）  
- **年間リターンの標準偏差**: 約8.46%（0.5353% × √250）  
- **年間実運用リターンの標準偏差**: 約26.24%（1.6594% × √250）  
- **年間シャープレシオ**: 約3.89

#### その他の指標
- **最大モデルドローダウン実績**: 4.902%  
- **最大実運用ドローダウン実績**: 11.613%  
- **最大ドローダウン日数実績**: 54日  
- **Spearman相関平均**: 0.05171  
- **Numerai相関平均**: 0.05767

## 10. 使用方法

1. 環境設定:
   - J-Quants API、SBI証券のクレデンシャル設定
   - セクター定義ファイルの準備

2. 実行:
   ```python
   python PO48Ensemble_fixed_241014.py
   ```

3. パラメータ調整:
   - `trading_sector_num`: 取引対象セクター数
   - `candidate_sector_num`: 候補セクター数
   - `top_slope`: 最上位・最下位セクターへの傾斜度
   - 学習期間の指定

4. 学習モード:
   - `learn=True` で再学習モードに設定

## 11. 注意事項

- 本戦略はリスク中立型の市場中立Long-Short戦略
- リアルタイムの市場状況によって取引可能性が変動
- SBI証券での信用取引ルールに依存
- モデルのドリフトに注意し、定期的な再学習を推奨