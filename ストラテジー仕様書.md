# 株式市場における多層モデルのLong-Short戦略仕様書

## 1. プロジェクト概要

### 目的
このストラテジーの主な目的は、**リスクを抑えながら大きなリターンを得る**こと。特にドローダウン（資産の大幅な減少）を最小限に抑えることで、安定したメンタルを維持しながら運用を続けることを重視しています。

### 対象銘柄
ユニバースとして、**TOPIX Core30・TOPIX Large70・TOPIX Mid400・TOPIX Small 1**に属する銘柄（およそ830銘柄）を選定しています。

### 日本株を取引対象に選んだ理由
1. **データ取得の容易性**  
   - 個別銘柄の値動きや財務情報に至るまで、データを取得しやすい。
2. **特徴量設計のしやすさ**  
   - 日本市場が米国市場のクローズ後に開場するため、**米株・為替・債券・商品**などの情報を特徴量として活用しやすい。

### 大型株を取引対象に選んだ理由
1. **信用売りが可能**
   - 上記ユニバースに含まれる銘柄の多くが信用取引に対応しており、柔軟な売買戦略を組むことができる。
2. **流動性が高い**
   - 出来高が多く、注文がスムーズに成立しやすいため、運用効率が高い。
3. **値動きが予測しやすい**
   - 投機的な動きが少なく、比較的予測可能な値動きが期待できる。
4. **マーケットインパクトを抑えやすい**
   - 運用資金が増えた場合でも、市場に与える影響を最小限に抑えた取引が可能。

### 業種分類
ユニバース銘柄をTOPIX500構成銘柄を独自に再定義した**48セクター**と、TOPIX1000構成銘柄を独自に再定義した**54セクター**に分類し、セクター単位で売買を行います。

#### 業種分類の利点
1. **分散効果**  
   - 業種ごとの取引でリスクを分散。
2. **柔軟性**  
   - 業種ごとの市場状況や特徴に応じたトレード戦略を適用可能。
3. **データ分析の効率化**  
   - 業種単位でのデータ集計と特徴量作成が可能。
4. **リターン予測のしやすさ**  
   - 業種ごとに特異なリターンを示すことが知られており、**業種間で予測結果の差異を出しやすい**。
   - **商社セクターと原油価格**のように、特定のセクターと指標のリターンとの相関が強い場合があり、予測精度を向上させやすい。
   - また、モデルの解釈性を担保しやすい。

#### 独自の業種再定義を行う理由
- **似通ったファクターの影響を受ける銘柄同士をグループ化**することで、予測精度を向上させるため。
  - 既存の**17業種**や**33業種**では、業種内の銘柄が必ずしも似通った値動きをしているわけではありません。
  - そのため、**似通った値動きをする銘柄をグループ化**し、それを基にインデックスを作成。

## 2. 基本アーキテクチャ

この戦略は以下の主要なコンポーネントから構成されています：

1. **データ取得・処理**
   - J-Quants APIを用いた株価情報・財務情報の取得
   - スクレイピングによる各種金融指標の取得
   - セクターインデックスの計算

2. **予測モデル**
   - 1つ目: TOPIX1000採用銘柄を54セクターに分類したLASSOモデル
   - 2つ目: TOPIX500採用銘柄を48セクターに分類したLASSOモデル
   - 両モデルの予測結果をもとに、各々の上位・下位セクターを取引
   - 資金配分は **54セクター : 48セクター = 0.67 : 0.33** の比率

3. **ポートフォリオ構築**
   - 上位・下位セクターの選択
   - 銘柄選択とウェイト付け
   - 発注処理

4. **実行モジュール**
   - SBI証券APIとの連携
   - 取引履歴の管理

## 3. 売買条件

### 1. 売買トリガー
- 業種ごとの**当日日中リターン**（前処理済みデータ）を、機械学習で予測。
  - **上位2業種**を信用買い。
  - **下位2業種**を信用売り。
- **注文タイミング**: 寄付（寄成注文）。
- **決済方法**: 当日の引成で全て決済。
- **業種数の選定理由**:
  - 上下1業種だとリターンは大きいものの、リスク分散のため**2業種**とする。
  - セクター内で半数超の銘柄が取引不可の場合は、上位・下位**4業種**まで繰り上げ・繰り下げを許容。

### 2. リスク管理
- **利確・損切り条件**: なし（当日引けで必ず決済するため）。
- **最大ポジションサイズ**: 証券会社の定める上限単位数および空売り規制ルールに従う。
  - 独自の基準は特に設けていない。
- **マーケットトレンドのリスク回避**:  
  - 買いポジションと売りポジションの発注金額をほぼ同額に調整。これにより、マーケット全体のトレンド（上昇/下落）の影響を受けにくくし、リスクを低減している。
- **具体的なリスク管理の対応**:  
  - **最大保有単元数の管理**:  
    - 証券会社が規定する最大保有単元数を超えないように発注することで、リスクを管理。
  - **空売り規制への対応**:  
    - **すべての信用新規売り**は、**前日終値の90.5%程度の低い値段での指値注文**として発注することで、空売り規制を回避。

### 3. トレード頻度・期間
- **頻度**: 年間約250回のトレード（毎営業日）。
  - トレード回数が多いため、**期待値に近い結果を得やすい**設計。
- **保持期間**: 当日中（寄り付きでポジションを取り、引けで決済）。
  - 短期スパンの方が情報の劣化を防ぎ、機械学習による予測精度を保ちやすい。
  - **取引コストの優位性**:  
    - 寄引戦略では**手数料・信用料がゼロ**となるため、コスト面で有利。

## 4. データ取得と前処理

### 4.1 取得するデータ

- **株価データ**: J-Quants APIから取得（`StockAcquisitionFacade` クラス）
  - OHLCV（始値、高値、安値、終値、出来高）
  - 調整係数

- **財務データ**: J-Quants APIから取得
  - 発行済株式数
  - 予想EPS

- **市場指標データ**: スクレイピングで取得（`FeaturesUpdater` クラス）
  - 通貨ペア（USD/JPY、EUR/JPY など）
  - 債券（国債）
  - コモディティ
  - TOPIXなどの指数

### 4.2 セクター定義

- カスタム定義の48セクター分類（TOPIX500銘柄を基に再定義）と、54セクター分類（TOPIX1000銘柄を基に再定義）の2種類を使用
- `SECTOR_REDEFINITIONS_CSV` パスで指定されたCSVファイルに各セクター定義が記載

### 4.3 データ前処理

- **セクターインデックスの計算** (`SectorIndexCalculator` クラス)
  - 各銘柄の時価総額加重平均によりセクターインデックスを算出
  - 株式分割・併合を考慮した調整

- **目的変数の計算** (`TargetCalculator` クラス)
  - **定義**: 業種別インデックスの日中リターン（PCAでマーケットファクターを除去）
  - **計算方法**: 当日終値 / 当日始値 - 1
  - **PCAによるマーケットファクター除去の理由**:  
    - 主成分分析では、分散が最も大きい軸を第一主成分とする
    - 株式市場では、最も大きなファクターがマーケットリターンであるため、第一主成分を除去することで業種固有の値動きを抽出

- **特徴量の計算** (`FeaturesCalculator` クラス)
  - **外部データ**: 各種データの1日リターン
  - **業種別インデックス**: モメンタム（移動平均）とボラティリティ（標準偏差）を5日・21日スパンで算出
  - **業種情報**: カテゴリ変数として利用
  - **前段モデルの予測結果**: LASSOの生の予測値をLightGBMで使用
  - 通貨相対強度
  - 債券イールドとイールドカーブ
  - セクターの時価総額と予想EPS
  - 各指標のセクター内ランキング

## 5. 予測モデル

### 5.1 LASSO回帰モデル

1. **モデル概要**  
   - **特徴量を削減**しオーバーフィッティングを防止
   - **重要な特徴量に絞り込み解釈性を向上**
   - **業種ごとのモデリング理由**:  
     - 業種ごとに異なるファクターの影響を受けるため、それぞれに適した特徴量を採用
   - 使用ライブラリ: **scikit-learn**
    - **業種別に独立したモデル**を構築（TOPIX1000の54セクター版とTOPIX500の48セクター版）

2. **入力データ**  
   - 主に経済指標データ（通貨、債券、コモディティ等）
   - 外部データの1日リターンのみを採用

3. **出力データ**
   - 各業種の日中リターンを予測
   - **得られた順位を用いて取引セクターを決定**

4. **特徴量選択**
   - 最大5、最小3の特徴量を自動選択

5. **学習パラメータ**
   - RandomizedSearchCVによるalpha最適化

### 5.2 LightGBMモデル（現行バージョンでは未使用）

以前のバージョンではLASSOとLightGBMの二段構えで学習を行っていましたが、
`PO48_54_Lasso.py` ではLightGBMモデルを利用していません。

### 5.3 2モデルの活用方法

1. **方法**
   - それぞれのモデルが予測した上位・下位セクターを個別に取引
   - 資金配分を **54セクター : 48セクター = 0.67 : 0.33** の比率で調整

2. **意図**
   - 互いに異なるセクター分類の強みを活かし、より安定した成績を狙う

3. **出力**
   - 各モデルが算出したセクター順位
   - 取引額をモデル比率に基づき分配

## 6. ポートフォリオ構築

### 6.1 セクター選択

- 予測結果上位と下位からそれぞれ**2個**のセクターを選択
- 取引可能性を考慮し、セクター内で取引不可銘柄が半数を超える場合は次点セクターに繰り上げ・繰り下げて**最大4業種**まで拡大
- 必要に応じて、候補セクター数を調整（デフォルト候補数=4）

### 6.2 銘柄選択ロジック

- 各セクター内で時価総額ウェイトに基づいて銘柄を選択
- 実際の購入単位数（100株単位）と理想的なウェイトとの調整
- 取引制限（信用建余力、空売り制限）の考慮

### 6.3 ポジションサイジング

- セクターごとの配分：均等配分がデフォルト
- セクター間での傾斜配分も可能（パラメータ `top_slope` で調整）
- 信用建余力に基づく総投資額の調整

## 7. 執行ロジック

### 7.1 取引タイミング

フラグ管理システム（`FlagManager` クラス）によって以下の実行タイミングを制御:

- **FETCH_DATA**: 7:00〜8:59（市場開場日のみ）
- **PREDICT**: 7:00〜8:59（市場開場日のみ）
- **TAKE_NEW_POSITIONS**: 7:00〜8:59（市場開場日のみ）
- **TAKE_ADDITIONAL_POSITIONS**: 9:00〜9:29（市場開場日のみ）
- **SETTLE_POSITIONS**: 11:30〜15:19（市場開場日のみ）
- **FETCH_RESULT**: 15:30〜23:59（市場開場日のみ）
@@ -254,51 +235,51 @@

### 7.4 エラー処理

- 発注失敗時の再試行機能
- エラーログの出力と通知

## 8. システム構成

### 8.1 主要クラス構成

- **SBIとの連携**
  - `SBIBrowserManager`: SBI証券ページへのアクセス管理
  - `MarginManager`: 信用建余力・買付余力の取得
  - `TradePossibilityManager`: 取引可能性情報の管理
  - `HistoryManager`: 取引履歴の管理

- **トレード管理**
  - `StockSelector`: 銘柄選択ロジック
  - `NewOrderMaker`: 新規注文発注
  - `PositionSettler`: ポジション決済
  - `TradeParameters`: 注文パラメータ管理

- **モデル管理**
  - `MLDataset`: 機械学習データセット管理
  - `LassoModel`: LASSO回帰モデル
  - `LgbmModel`: LightGBMモデル（現行バージョンでは未使用）

### 8.2 データ永続化

- 学習済みモデルの保存
- 予測結果の保存
- 取引履歴の保存
- エラーログの保存

### 8.3 通知システム

- `SlackNotifier`: Slack連携による通知機能
  - プログラム開始・終了通知
  - エラー通知
  - 取引結果通知

## 9. バックテスト結果とパフォーマンス評価

### 9.1 テスト設定

| 項目 | 内容 |
|------|------|
| **学習期間** | 2014/01/01 – 2021/12/31 |
| **テスト期間** | 2022/01/01 – 2025/06/23 |
| **共通前提** | 252 日/年換算、税率 20.315%、手数料 0 円、レバレッジ 3.1 倍 |

---

### 9.2 モデル別主要指標比較（税引後・レバレッジ込み）

| 指標 | ① 旧48 LASSO+LGBM | ② 現48 LASSO | ③ 現54 LASSO | ④ 2モデル併用<sup>※実運用</sup> |
|------|------------------|--------------|--------------|----------------|
| **日次平均リターン** | **0.3088 %** | 0.2716 % | 0.2511 % | 0.2579 % |
| **年率リターン (CAGR)** | **117.49 %** | 98.08 % | 88.13 % | 91.37 % |
| **日次標準偏差** | 1.6291 % | 1.5658 % | 1.1378 % | **1.1030 %** |
| **予想最大 DD** | 19.34 % | 20.31 % | 11.60 % | **10.61 %** |
| **シャープレシオ** | 0.1895 | 0.1733 | 0.2189 | **0.2339** |
| **Calmar** | 6.08 | 4.83 | 7.60 | **8.61** |

> **ハイライト**  
> - ④はリスク水準（標準偏差・ドローダウン）を最小化しつつ、③を上回るリスク調整後リターン（シャープ 0.23、Calmar 8.6）を達成。  
> - 純粋なリターンだけでは①が最大だが、ボラティリティと DD が大きく、効率指標では④が最優秀。  
> - ②→③→④ の順にセクター再定義とモデル併用が効き、パフォーマンス効率が改善している点に注目。

---

### 9.3 ④モデルの位置付けと今後の詳細分析

- **実運用採用理由**  
  - ボラティリティ・ドローダウンを他モデル比で 30–45 % 低減。  
  - シャープ／Calmar いずれも最高値で、資産曲線の安定性が高い。  
- **残課題**  
  - ポジション内訳（Long／Short・セクター別）、月次リターン推移、相関指標（Spearman・Numerai）などの詳細を追加検証予定。  
  - コスト前提（スリッページ）の感度分析を行い、実売買への落とし込み精度を向上させる。  


## 10. 使用方法

1. 環境設定:
   - J-Quants API、SBI証券のクレデンシャル設定
   - セクター定義ファイルの準備

2. 実行:
   ```python
   python PO48Ensemble_fixed_241014.py
   ```

3. パラメータ調整:
   - `trading_sector_num`: 取引対象セクター数
   - `candidate_sector_num`: 候補セクター数
   - `top_slope`: 最上位・最下位セクターへの傾斜度
   - 学習期間の指定

4. 学習モード:
   - 再学習は行わないため、`learn=True` オプションは使用しない

## 11. 注意事項

- 本戦略はリスク中立型の市場中立Long-Short戦略
- リアルタイムの市場状況によって取引可能性が変動
- SBI証券での信用取引ルールに依存